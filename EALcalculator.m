function [ EAL, lossExceedenceCurve ] = EALcalculator(...
    expectedLossCurves, hazardCurves, plotter,varargin )
%EALcalculator calculates the expected annual loss provided a set of
%vulnerability functions and hazard curves
%
% (DS) Modified on 03/10/2022 to include option to compute 
%      losses due to collapse
%
%
%   Note: if the hazard curve does not start from zero, this function
%   will extrapolate it for values smaller than IMmin
%
%   collapseFrag        array containing the IM in the first column
%                       Pcollapse|IM in the second column
%  	expectedLossCurves  array containing the IM in the first column,
%                       loss ratios | IM in the other columns
%   hazardCurves        array containing the IM in the first column,
%                       MAFE of IM in the other columns
%                       IT MUST HAVE THE SAME NUMBER OF COLUMNS THAN
%                       "vulnerabilities"

%% Example

% vulnerability = [0,0,0,0;0.0500000000000000,4.70302973241152e-12,4.70302973241152e-12,4.70302973241152e-12;0.100000000000000,9.67754899629492e-06,9.67754899629492e-06,9.67754899629492e-06;0.150000000000000,0.00112698573115912,0.00112698573115912,0.00112698573115912;0.200000000000000,0.00717313814937606,0.00717313814937606,0.00717313814937606;0.250000000000000,0.0154177923755553,0.0154177923755553,0.0154177923755553;0.300000000000000,0.0242533506354697,0.0242533506354697,0.0242533506354697;0.350000000000000,0.0371232589412291,0.0371232589412291,0.0371232589412291;0.400000000000000,0.0547940483359678,0.0547940483359678,0.0547940483359678;0.450000000000000,0.0761580875380843,0.0761580875380843,0.0761580875380843;0.500000000000000,0.102349671457028,0.102349671457028,0.102349671457028;0.550000000000000,0.137036561462965,0.137036561462965,0.137036561462965;0.600000000000000,0.183882305471137,0.183882305471137,0.183882305471137;0.650000000000000,0.244295470643605,0.244295470643605,0.244295470643605;0.700000000000000,0.316780653125123,0.316780653125123,0.316780653125123;0.750000000000000,0.397590349532314,0.397590349532314,0.397590349532314;0.800000000000000,0.481910969188673,0.481910969188673,0.481910969188673;0.850000000000000,0.564988564101765,0.564988564101765,0.564988564101765;0.900000000000000,0.642905214926925,0.642905214926925,0.642905214926925;0.950000000000000,0.712950049816945,0.712950049816945,0.712950049816945;1,0.773657216896249,0.773657216896249,0.773657216896249;1.05000000000000,0.824629776806451,0.824629776806451,0.824629776806451;1.10000000000000,0.866264388508343,0.866264388508343,0.866264388508343;1.15000000000000,0.899463071348441,0.899463071348441,0.899463071348441;1.20000000000000,0.925383878737981,0.925383878737981,0.925383878737981;1.25000000000000,0.945252798127726,0.945252798127726,0.945252798127726;1.30000000000000,0.960238848438126,0.960238848438126,0.960238848438126;1.35000000000000,0.971383120058850,0.971383120058850,0.971383120058850;1.40000000000000,0.979568250216904,0.979568250216904,0.979568250216904;1.45000000000000,0.985514938995969,0.985514938995969,0.985514938995969;1.50000000000000,0.989794387712279,0.989794387712279,0.989794387712279;1.55000000000000,0.992848479997810,0.992848479997810,0.992848479997810;1.60000000000000,0.995012280663237,0.995012280663237,0.995012280663237;1.65000000000000,0.996535632006323,0.996535632006323,0.996535632006323;1.70000000000000,0.997602208592474,0.997602208592474,0.997602208592474;1.75000000000000,0.998345423787204,0.998345423787204,0.998345423787204;1.80000000000000,0.998861191304741,0.998861191304741,0.998861191304741;1.85000000000000,0.999217860527368,0.999217860527368,0.999217860527368;1.90000000000000,0.999463771322546,0.999463771322546,0.999463771322546;1.95000000000000,0.999632890868098,0.999632890868098,0.999632890868098;2,0.999748954679863,0.999748954679863,0.999748954679863;2.05000000000000,0.999828469903070,0.999828469903070,0.999828469903070;2.10000000000000,0.999882870156286,0.999882870156286,0.999882870156286;2.15000000000000,0.999920047684166,0.999920047684166,0.999920047684166;2.20000000000000,0.999945434453265,0.999945434453265,0.999945434453265;2.25000000000000,0.999962760047783,0.999962760047783,0.999962760047783;2.30000000000000,0.999974580073420,0.999974580073420,0.999974580073420;2.35000000000000,0.999982642846876,0.999982642846876,0.999982642846876;2.40000000000000,0.999988142862100,0.999988142862100,0.999988142862100;2.45000000000000,0.999991895413472,0.999991895413472,0.999991895413472;2.50000000000000,0.999994456567618,0.999994456567618,0.999994456567618;2.55000000000000,0.999996205398704,0.999996205398704,0.999996205398704;2.60000000000000,0.999997400250990,0.999997400250990,0.999997400250990;2.65000000000000,0.999998217173454,0.999998217173454,0.999998217173454;2.70000000000000,0.999998776144347,0.999998776144347,0.999998776144347;2.75000000000000,0.999999158948468,0.999999158948468,0.999999158948468;2.80000000000000,0.999999421356204,0.999999421356204,0.999999421356204;2.85000000000000,0.999999601417114,0.999999601417114,0.999999601417114;2.90000000000000,0.999999725106403,0.999999725106403,0.999999725106403;2.95000000000000,0.999999810169043,0.999999810169043,0.999999810169043;3,0.999999868737184,0.999999868737184,0.999999868737184];
% hazardCurve   = [0.0500000000000000,0.0359165441238759,0.0359165441238759,0.0359165441238759;0.100000000000000,0.0214149470403168,0.0214149470403168,0.0214149470403168;0.150000000000000,0.0141288173865274,0.0141288173865274,0.0141288173865274;0.200000000000000,0.0100437113851045,0.0100437113851045,0.0100437113851045;0.250000000000000,0.00767863362714298,0.00767863362714298,0.00767863362714298;0.300000000000000,0.00608342464212812,0.00608342464212812,0.00608342464212812;0.350000000000000,0.00501480789002844,0.00501480789002844,0.00501480789002844;0.400000000000000,0.00417984570883490,0.00417984570883490,0.00417984570883490;0.450000000000000,0.00355345234307129,0.00355345234307129,0.00355345234307129;0.500000000000000,0.00306210689702328,0.00306210689702328,0.00306210689702328;0.550000000000000,0.00265756689564624,0.00265756689564624,0.00265756689564624;0.600000000000000,0.00235526466285869,0.00235526466285869,0.00235526466285869;0.650000000000000,0.00212683409883222,0.00212683409883222,0.00212683409883222;0.700000000000000,0.00191415031415710,0.00191415031415710,0.00191415031415710;0.750000000000000,0.00173491167801875,0.00173491167801875,0.00173491167801875;0.800000000000000,0.00157161733797149,0.00157161733797149,0.00157161733797149;0.850000000000000,0.00144363552062756,0.00144363552062756,0.00144363552062756;0.900000000000000,0.00133465010489144,0.00133465010489144,0.00133465010489144;0.950000000000000,0.00123549224420488,0.00123549224420488,0.00123549224420488;1,0.00114152496535817,0.00114152496535817,0.00114152496535817;1.05000000000000,0.00105045132688451,0.00105045132688451,0.00105045132688451;1.10000000000000,0.000970843977218302,0.000970843977218302,0.000970843977218302;1.15000000000000,0.000905477311111123,0.000905477311111123,0.000905477311111123;1.20000000000000,0.000840110645003945,0.000840110645003945,0.000840110645003945;1.25000000000000,0.000782620855512434,0.000782620855512434,0.000782620855512434;1.30000000000000,0.000737640819650741,0.000737640819650741,0.000737640819650741;1.35000000000000,0.000692660783789047,0.000692660783789047,0.000692660783789047;1.40000000000000,0.000647680747927353,0.000647680747927353,0.000647680747927353;1.45000000000000,0.000602700712065659,0.000602700712065659,0.000602700712065659;1.50000000000000,0.000573203422687330,0.000573203422687330,0.000573203422687330;1.55000000000000,0.000544695137779339,0.000544695137779339,0.000544695137779339;1.60000000000000,0.000516186852871348,0.000516186852871348,0.000516186852871348;1.65000000000000,0.000487678567963358,0.000487678567963358,0.000487678567963358;1.70000000000000,0.000459170283055367,0.000459170283055367,0.000459170283055367;1.75000000000000,0.000430661998147376,0.000430661998147376,0.000430661998147376;1.80000000000000,0.000402153713239386,0.000402153713239386,0.000402153713239386;1.85000000000000,0.000389826751624077,0.000389826751624077,0.000389826751624077;1.90000000000000,0.000378822138580562,0.000378822138580562,0.000378822138580562;1.95000000000000,0.000367817525537048,0.000367817525537048,0.000367817525537048;2,0.000356812912493534,0.000356812912493534,0.000356812912493534;2.05000000000000,0.000345808299450019,0.000345808299450019,0.000345808299450019;2.10000000000000,0.000334803686406505,0.000334803686406505,0.000334803686406505;2.15000000000000,0.000323799073362990,0.000323799073362990,0.000323799073362990;2.20000000000000,0.000312794460319476,0.000312794460319476,0.000312794460319476;2.25000000000000,0.000301789847275961,0.000301789847275961,0.000301789847275961;2.30000000000000,0.000290785234232447,0.000290785234232447,0.000290785234232447;2.35000000000000,0.000279780621188932,0.000279780621188932,0.000279780621188932;2.40000000000000,0.000268776008145418,0.000268776008145418,0.000268776008145418;2.45000000000000,0.000257771395101903,0.000257771395101903,0.000257771395101903;2.50000000000000,0.000246766782058389,0.000246766782058389,0.000246766782058389;2.55000000000000,0.000235762169014874,0.000235762169014874,0.000235762169014874;2.60000000000000,0.000224757555971360,0.000224757555971360,0.000224757555971360;2.65000000000000,0.000213752942927845,0.000213752942927845,0.000213752942927845;2.70000000000000,0.000202748329884331,0.000202748329884331,0.000202748329884331];
% collapseFrg   = [0,6.05452918598545e-25,4.78162116416494e-20,1.90226049125535e-17,1.01230921185301e-15,1.89025731293105e-14,1.86802520846809e-13,1.20737096421593e-12,5.77020647899488e-12,2.20266723387227e-11,7.07108461606459e-11,1.97896777933635e-10,4.95609098832688e-10,1.13252356983028e-09,2.39681465347591e-09,4.75286389161771e-09,8.91308398743170e-09,1.59255893748923e-08,2.72779002918555e-08,4.50163411762906e-08,7.18803132635564e-08,1.11450204061297e-07,1.68307353368525e-07,2.48204230614803e-07,3.58242790484461e-07,5.07058858480165e-07,7.05010348370365e-07,9.64367121123507e-07,1.29950035115310e-06,1.72706936166629e-06,2.26620401819010e-06,2.93868092014988e-06,3.76909179768819e-06,4.78500269859587e-06,6.01710273301478e-06,7.49934132704181e-06,9.26905311689769e-06,1.13670697900261e-05,1.38378183461138e-05,1.67294054079037e-05,2.00936873576263e-05,2.39863262091449e-05,2.84668312480904e-05,3.35985865822269e-05,3.94488648421585e-05,4.60888273585595e-05,5.35935112168190e-05,6.20418036538930e-05,7.15164043158671e-05,8.21037759389247e-05,9.38940840517991e-05,0.000106981126325065,0.000121462252212505,0.000137438273542993,0.000155013366728506,0.000174294967255694,0.000195393657125483,0.000218423045898101,0.000243499645990153,0.000270742742856533,0.000300274260673419,0.000332218624119895,0.000366702616835120,0.000403855237105948,0.000443807551316643,0.000486692545668310,0.000532644976650888,0.000581801220725556,0.000634299123650082,0.000690277849854448,0.000749877732248968,0.000813240122822305,0.000880507244362425,0.000951822043609668,0.00102732804612775,0.00110716921315596,0.00119148980068393,0.00128043422096899,0.00137414690669616,0.00147277217796083,0.00157645411223584,0.00168533641746674,0.00179956230842175,0.00191927438640724,0.00204461452244385,0.00217572374398401,0.00231274212523819,0.00245580868116382,0.00260506126515943,0.00276063647049452,0.00292266953549577,0.00309129425249975,0.00326664288057348,0.00344884606199558,0.00363803274248275,0.00383433009513919,0.00403786344809983,0.00424875621583201,0.00446712983405483,0.00469310369823012,0.00492679510557444,0.00516831920053722,0.00541778892368668,0.00567531496394157,0.00594100571408375,0.00621496722948451,0.00649730318997462,0.00678811486478661,0.00708750108049607,0.00739555819188721,0.00771238005566696,0.00803805800695104,0.00837268083844466,0.00871633478224032,0.00906910349415451,0.00943106804052577,0.00980230688739565,0.0101828958919956,0.0105729082964621,0.0109724147237036,0.0113814831753430,0.0118001790316613,0.0122285650534660,0.0126667013858133,0.0131146455635099,0.0135724525183232,0.0140401745878306,0.0145178615258379,0.0150055605142997,0.0155033161766746,0.0160111705926512,0.0165291633141801,0.0170573313827496,0.0175957093478455,0.0181443292865332,0.0187032208241058,0.0192724111557416,0.0198519250691139,0.0204417849679019,0.0210420108961486,0.0216526205634156,0.0222736293706855,0.0229050504369633,0.0235468946265317,0.0241991705768129,0.0248618847267959,0.0255350413459847,0.0262186425638277,0.0269126883995882,0.0276171767926178,0.0283321036329960,0.0290574627924995,0.0297932461558678,0.0305394436523310,0.0312960432873678,0.0320630311746642,0.0328403915682409,0.0336281068947235,0.0344261577857257,0.0352345231103207,0.0360531800075756,0.0368821039191231,0.0377212686217491,0.0385706462599723,0.0394302073785962,0.0402999209552115,0.0411797544326311,0.0420696737512372,0.0429696433812252,0.0438796263547249,0.0447995842977858,0.0457294774622083,0.0466692647572091,0.0476189037809046,0.0485783508516009,0.0495475610388778,0.0505264881944544,0.0515150849828259,0.0525133029116611,0.0535210923619513,0.0545384026178997,0.0555651818965455,0.0566013773771117,0.0576469352300713,0.0587018006459235,0.0597659178636745,0.0608392301990153,0.0619216800721931,0.0630132090355687,0.0641137578008574,0.0652232662660476,0.0663416735419938,0.0674689179786803,0.0686049371911531,0.0697496680851156,0.0709030468821877,0.0720650091448242,0.0732354898008921,0.0744144231679045,0.0756017429769104,0.0767973823960381,0.0780012740536937,0.0792133500614117,0.0804335420363601,0.0816617811234971,0.0828979980173825,0.0841421229836417,0.0853940858800846,0.0866538161774800,0.0879212429799851,0.0891962950452333,0.0904789008040796,0.0917689883800075,0.0930664856081957,0.0943713200542498,0.0956834190325981,0.0970027096245559,0.0983291186960580,0.0996625729150637,0.101002998768635,0.102350322579693,0.103704470523450,0.105065368643527,0.106432942867751,0.107807119023644,0.109187822853600,0.110574980029752,0.111968516168538,0.113368356844966,0.114774427606576,0.116186653987115,0.117604961519913,0.119029275750969,0.120459522251762,0.121895626631766,0.123337514550698,0.124785111730481,0.126238343966939,0.127697137141225,0.129161417230979,0.130631110321223,0.132106142615006,0.133586440443781,0.135071930277538,0.136562538734687,0.138058192591696,0.139558818792482,0.141064344457574,0.142574696893028,0.144089803599121,0.145609592278811,0.147133990845974,0.148662927433421,0.150196330400690,0.151734128341633,0.153276250091782,0.154822624735516,0.156373181613012,0.157927850327005,0.159486560749343,0.161049243027348,0.162615827589986,0.164186245153847,0.165760426728940,0.167338303624304,0.168919807453441,0.170504870139572,0.172093423920719,0.173685401354618,0.175280735323461,0.176879359038479,0.178481206044358,0.180086210223499,0.181694305800125,0.183305427344227,0.184919509775370,0.186536488366341,0.188156298746664,0.189778876905961,0.191404159197184,0.193032082339705,0.194662583422271,0.196295599905834,0.197931069626244,0.199568930796823,0.201209122010810,0.202851582243688,0.204496250855389,0.206143067592387,0.207791972589674,0.209442906372622,0.211095809858740,0.212750624359321,0.214407291580988,0.216065753627129,0.217725952999240,0.219387832598167,0.221051335725247,0.222716406083363,0.224382987777900,0.226051025317614,0.227720463615414,0.229391247989053,0.231063324161739,0.232736638262663,0.234411136827449,0.236086766798515,0.237763475525372,0.239441210764838,0.241119920681181,0.242799553846189,0.244480059239177,0.246161386246919,0.247843484663511,0.249526304690181,0.251209796935024,0.252893912412679,0.254578602543951,0.256263819155364,0.257949514478667,0.259635641150279,0.261322152210681,0.263009001103753,0.264696141676064,0.266383528176110,0.268071115253500,0.269758857958099,0.271446711739122,0.273134632444189,0.274822576318324,0.276510500002927,0.278198360534693,0.279886115344496,0.281573722256233,0.283261139485634,0.284948325639029,0.286635239712084,0.288321841088499,0.290008089538681,0.291693945218371,0.293379368667256,0.295064320807534,0.296748762942464,0.298432656754878,0.300115964305672,0.301798648032264,0.303480670747034,0.305161995635733,0.306842586255873,0.308522406535088,0.310201420769480,0.311879593621937,0.313556890120438,0.315233275656330,0.316908715982591,0.318583177212075,0.320256625815738,0.321929028620845,0.323600352809169,0.325270565915162,0.326939635824126,0.328607530770356,0.330274219335280,0.331939670445583,0.333603853371314,0.335266737723990,0.336928293454684,0.338588490852103,0.340247300540656,0.341904693478516,0.343560640955671,0.345215114591962,0.346868086335126,0.348519528458820,0.350169413560642,0.351817714560148,0.353464404696863,0.355109457528285,0.356752846927884,0.358394547083099,0.360034532493331,0.361672777967929,0.363309258624181,0.364943949885289,0.366576827478358,0.368207867432370,0.369837046076164,0.371464340036411,0.373089726235593,0.374713181889974,0.376334684507580,0.377954211886170,0.379571742111219,0.381187253553889,0.382800724869010,0.384412134993063,0.386021463142156,0.387628688810015,0.389233791765966,0.390836752052922,0.392437549985384,0.394036166147426,0.395632581390700,0.397226776832438,0.398818733853454,0.400408434096160,0.401995859462576,0.403580992112351,0.405163814460790,0.406744309176876,0.408322459181311,0.409898247644552,0.411471657984857,0.413042673866333,0.414611279196999,0.416177458126841,0.417741195045887,0.419302474582277,0.420861281600351,0.422417601198730,0.423971418708418,0.425522719690901,0.427071489936254,0.428617715461264,0.430161382507547,0.431702477539683,0.433240987243354,0.434776898523493,0.436310198502432,0.437840874518072,0.439368914122048,0.440894305077909,0.442417035359305,0.443937093148181,0.445454466832982,0.446969145006861,0.448481116465904,0.449990370207355,0.451496895427855,0.453000681521687,0.454501718079033,0.455999994884236,0.457495501914075,0.458988229336045,0.460478167506645,0.461965306969685,0.463449638454589,0.464931152874715,0.466409841325683,0.467885695083713,0.469358705603966,0.470828864518904,0.472296163636653,0.473760594939378,0.475222150581665,0.476680822888913,0.478136604355742,0.479589487644397,0.481039465583174,0.482486531164852,0.483930677545130,0.485371898041079,0.486810186129602,0.488245535445900,0.489677939781957,0.491107393085022,0.492533889456109,0.493957423148506,0.495377988566292,0.496795580262862,0.498210192939465,0.499621821443747,0.501030460768311,0.502436106049279,0.503838752564869,0.505238395733975,0.506635031114766,0.508028654403287,0.509419261432070,0.510806848168760,0.512191410714745,0.513572945303798,0.514951448300727,0.516326916200035,0.517699345624593,0.519068733324315,0.520435076174848,0.521798371176273,0.523158615451807,0.524515806246524,0.525869940926077,0.527221016975438,0.528569031997638,0.529913983712522,0.531255869955514,0.532594688676385,0.533930437938038,0.535263115915295,0.536592720893699,0.537919251268320,0.539242705542573,0.540563082327046,0.541880380338333,0.543194598397877,0.544505735430828,0.545813790464899,0.547118762629242,0.548420651153320,0.549719455365804,0.551015174693463,0.552307808660073,0.553597356885328,0.554883819083766,0.556167195063699,0.557447484726148,0.558724688063801,0.559998805159959,0.561269836187506,0.562537781407885,0.563802641170071,0.565064415909569,0.566323106147407,0.567578712489147,0.568831235623890,0.570080676323310,0.571327035440676,0.572570313909891,0.573810512744545,0.575047633036959,0.576281675957256,0.577512642752425,0.578740534745404,0.579965353334159,0.581187099990782,0.582405776260590,0.583621383761235,0.584833924181814,0.586043399282003,0.587249810891177,0.588453160907555,0.589653451297346,0.590850684093895,0.592044861396853,0.593235985371337,0.594424058247111,0.595609082317761,0.596791059939891,0.597969993532315,0.599145885575260,0.600318738609581,0.601488555235971,0.602655338114192,0.603819089962300,0.604979813555887,0.606137511727325,0.607292187365014,0.608443843412643,0.609592482868453,0.610738108784510,0.611880724265981,0.613020332470417,0.614156936607047,0.615290539936072,0.616421145767970,0.617548757462805,0.618673378429545,0.619795012125379,0.620913662055052,0.622029331770197,0.623142024868672,0.624251744993914,0.625358495834285,0.626462281122435,0.627563104634667,0.628660970190303,0.629755881651065,0.630847842920457,0.631936857943150,0.633022930704379,0.634106065229341,0.635186265582602,0.636263535867503,0.637337880225581,0.638409302835991,0.639477807914929,0.640543399715070,0.641606082525000,0.642665860668667,0.643722738504825,0.644776720426487,0.645827810860388,0.646876014266449,0.647921335137244,0.648963777997479,0.650003347403467,0.651040047942617,0.652073884232922,0.653104860922457,0.654132982688873,0.655158254238907,0.656180680307891,0.657200265659263,0.658217015084092,0.659230933400595,0.660242025453671,0.661250296114434,0.662255750279748,0.663258392871771,0.664258228837505,0.665255263148341,0.666249500799624,0.667240946810205,0.668229606222011,0.669215484099614,0.670198585529804,0.671178915621165,0.672156479503663,0.673131282328224,0.674103329266335,0.675072625509629,0.676039176269491,0.677002986776659,0.677964062280830,0.678922408050272,0.679878029371441,0.680830931548599,0.681781119903434,0.682728599774693,0.683673376517810,0.684615455504540,0.685554842122598,0.686491541775302,0.687425559881220,0.688356901873817,0.689285573201113,0.690211579325335,0.691134925722581,0.692055617882484,0.692973661307878,0.693889061514474,0.694801824030530,0.695711954396531,0.696619458164872,0.697524340899543,0.698426608175816,0.699326265579940,0.700223318708833,0.701117773169783,0.702009634580148,0.702898908567064,0.703785600767151,0.704669716826224,0.705551262399010,0.706430243148864,0.707306664747491,0.708180532874669,0.709051853217976,0.709920631472522,0.710786873340680,0.711650584531822,0.712511770762059,0.713370437753982,0.714226591236408,0.715080236944126,0.715931380617649,0.716780028002966,0.717626184851298,0.718469856918857,0.719311049966610,0.720149769760040,0.720986022068913,0.721819812667050,0.722651147332098,0.723480031845303,0.724306471991293,0.725130473557852,0.725952042335704,0.726771184118300,0.727587904701607,0.728402209883893,0.729214105465522,0.730023597248752,0.730830691037528,0.731635392637284,0.732437707854744,0.733237642497729,0.734035202374960,0.734830393295870,0.735623221070415,0.736413691508888,0.737201810421731,0.737987583619361,0.738771016911982,0.739552116109412,0.740330887020909,0.741107335454994,0.741881467219280,0.742653288120309,0.743422803963377,0.744190020552375,0.744954943689624,0.745717579175714,0.746477932809346,0.747236010387175,0.747991817703655,0.748745360550886,0.749496644718465,0.750245675993334,0.750992460159634,0.751737002998561,0.752479310288222,0.753219387803491,0.753957241315874,0.754692876593367,0.755426299400321,0.756157515497309,0.756886530640992,0.757613350583988,0.758337981074744,0.759060427857408,0.759780696671703,0.760498793252802,0.761214723331208,0.761928492632632,0.762640106877873,0.763349571782700,0.764056893057739,0.764762076408357,0.765465127534547,0.766166052130819,0.766864855886093,0.767561544483583,0.768256123600698,0.768948598908932,0.769638976073764,0.770327260754552,0.771013458604433,0.771697575270227,0.772379616392333,0.773059587604638,0.773737494534418,0.774413342802246,0.775087138021900,0.775758885800269,0.776428591737266,0.777096261425738,0.777761900451380,0.778425514392649,0.779087108820677,0.779746689299190,0.780404261384426,0.781059830625054,0.781713402562092,0.782364982728831,0.783014576650759,0.783662189845481,0.784307827822647,0.784951496083879,0.785593200122696,0.786232945424443,0.786870737466224,0.787506581716830,0.788140483636669,0.788772448677706,0.789402482283389,0.790030589888590,0.790656776919541,0.791281048793767,0.791903410920028,0.792523868698261,0.793142427519514,0.793759092765891,0.794373869810497,0.794986764017377,0.795597780741463,0.796206925328518,0.796814203115086,0.797419619428433,0.798023179586503,0.798624888897861,0.799224752661646,0.799822776167521,0.800418964695626,0.801013323516532,0.801605857891192,0.802196573070896,0.802785474297229,0.803372566802026,0.803957855807327,0.804541346525339,0.805123044158392,0.805702953898901,0.806281080929323,0.806857430422123,0.807432007539732,0.808004817434512,0.808575865248718,0.809145156114467,0.809712695153697,0.810278487478135,0.810842538189269,0.811404852378305,0.811965435126147,0.812524291503356,0.813081426570125,0.813636845376248,0.814190552961092,0.814742554353566,0.815292854572095,0.815841458624595,0.816388371508444,0.816933598210455,0.817477143706857,0.818019012963265,0.818559210934657,0.819097742565355,0.819634612788998,0.820169826528523,0.820703388696141,0.821235304193320,0.821765577910762,0.822294214728386,0.822821219515307,0.823346597129819,0.823870352419377,0.824392490220581,0.824913015359155,0.825431932649938,0.825949246896864,0.826464962892947,0.826979085420268,0.827491619249962,0.828002569142201,0.828511939846185,0.829019736100129,0.829525962631248,0.830030624155752,0.830533725378826,0.831035270994631,0.831535265686283,0.832033714125851,0.832530620974346,0.833025990881711,0.833519828486816,0.834012138417447,0.834502925290302,0.834992193710983,0.835479948273989,0.835966193562711,0.836450934149427,0.836934174595298,0.837415919450360,0.837896173253522,0.838374940532566,0.838852225804134,0.839328033573737,0.839802368335743,0.840275234573380,0.840746636758731,0.841216579352737,0.841685066805191,0.842152103554742,0.842617694028889,0.843081842643987,0.843544553805246,0.844005831906728,0.844465681331351,0.844924106450894,0.845381111625991,0.845836701206139,0.846290879529699,0.846743650923898,0.847195019704834,0.847644990177476,0.848093566635673,0.848540753362151,0.848986554628525,0.849430974695299,0.849874017811869,0.850315688216537,0.850755990136505,0.851194927787890,0.851632505375727,0.852068727093972,0.852503597125515,0.852937119642182,0.853369298804744,0.853800138762926,0.854229643655411,0.854657817609851,0.855084664742874,0.855510189160093,0.855934394956115,0.856357286214550,0.856778867008017,0.857199141398158,0.857618113435648,0.858035787160198,0.858452166600574,0.858867255774602,0.859281058689178,0.859693579340283,0.860104821712992,0.860514789781482,0.860923487509050,0.861330918848117,0.861737087740248,0.862141998116156,0.862545653895722,0.862948058987998,0.863349217291232,0.863749132692868,0.864147809069569,0.864545250287224,0.864941460200963,0.865336442655174,0.865730201483511,0.866122740508911,0.866514063543609,0.866904174389150,0.867293076836403,0.867680774665580,0.868067271646245,0.868452571537332,0.868836678087160,0.869219595033447,0.869601326103326,0.869981875013361,0.870361245469561,0.870739441167398,0.871116465791820,0.871492323017271,0.871867016507702,0.872240549916592,0.872612926886964,0.872984151051396,0.873354226032045,0.873723155440661,0.874090942878602,0.874457591936853,0.874823106196044,0.875187489226464,0.875550744588083,0.875912875830565,0.876273886493290,0.876633780105367,0.876992560185655,0.877350230242783,0.877706793775161,0.878062254271005,0.878416615208353,0.878769880055082,0.879122052268928,0.879473135297505,0.879823132578321,0.880172047538799,0.880519883596297,0.880866644158124,0.881212332621559,0.881556952373873,0.881900506792345,0.882242999244285,0.882584433087049,0.882924811668061,0.883264138324831,0.883602416384976,0.883939649166241,0.884275839976513,0.884610992113847,0.884945108866482,0.885278193512864,0.885610249321662,0.885941279551791,0.886271287452430,0.886600276263047,0.886928249213411,0.887255209523621,0.887581160404117,0.887906105055711,0.888230046669598,0.888552988427382,0.888874933501095,0.889195885053217,0.889515846236697,0.889834820194975,0.890152810061998,0.890469818962250,0.890785850010761,0.891100906313138,0.891414990965580,0.891728107054902,0.892040257658552,0.892351445844638,0.892661674671944,0.892970947189952,0.893279266438866,0.893586635449630,0.893893057243949,0.894198534834313,0.894503071224016]        
% [ EAL ] = EALcalculator(vulnerability, hazardCurve, 'plot');
% [ EAL ] = EALcalculator(vulnerability, hazardCurve, 'plot',collapseFrg,1);

%% Initial stuff

% Check optional input
nvarargin=length(varargin);
if nvarargin>3 || nvarargin==1
    error( 'myfuns:somefun2Alt:TooManyInputs', ...
        sprintf('requires %d optional inputs',2) );
end

% set varargin values
optargs = {zeros(length(expectedLossCurves)) 0 1};
optargs(1:nvarargin) = varargin; 


% Place optional args in memorable variable names
[collapseFrag,collapseDLR] = optargs{:};

% is vulnerability "long" enough?
if max(expectedLossCurves(:,1)) < max(hazardCurves(:,1))
    error('Extend the definition of the vulnerability curve(s)')
end
    
% interp hazard curve where the vulnerability is defined
temp = find(expectedLossCurves(:,1) >= max(hazardCurves(:,1)));
lastStepIM = temp(1)-1;
for h = size(hazardCurves,2) : -1 : 2
    hazardCurvesInterp(:,h) = interp1(...
        hazardCurves(:,1), hazardCurves(:,h), ...
        expectedLossCurves(1:lastStepIM,1), 'linear', 'extrap');
end
hazardCurvesInterp(:,1) = expectedLossCurves(1:lastStepIM,1);

%% Calculate MAFim (derivative of the hazard curves)

dy = -diff(hazardCurvesInterp(:,2:end)); % MAFE del IM più piccolo meno MAFE del IM più grande
dx = diff(hazardCurvesInterp(:,1)) * ones(1, size(hazardCurvesInterp,2)-1);
MAFim = dy ./ dx;

% assume that for the last IM point, for which I cannot calculate the
% derivative, the derivative is equal to the second-to-last one
MAFim(end+1,:) = MAFim(end,:);

%% Calculate EAL for each building (columns in vulnerabilities and hazardCurves)

% Compute losses due to repair and collapses, considering DLR=1 for
% collapse
MAFlr = expectedLossCurves(1:lastStepIM,2:end) .* MAFim .* (1-collapseFrag(1:lastStepIM,1))+...
    collapseDLR .* collapseFrag(1:lastStepIM,end) .* MAFim;

EAL = trapz(expectedLossCurves(1:lastStepIM,1), MAFlr); % Normalized for the relative cost of each subsystem

%% Loss exceedence curve

if nargout > 1
    for c = size(hazardCurves,2) : -1 : 2
        lossExceedenceCurve{c-1}(:,1) = interp1(...
            expectedLossCurves(:,1), expectedLossCurves(:,c), hazardCurvesInterp(:,1));
        lossExceedenceCurve{c-1}(:,2) = hazardCurvesInterp(:,c);
    end
end

% Sanity check: this also gives EAL
%  trapz(lossExceedenceCurve{c}(:,1), lossExceedenceCurve{c}(:,2)) 

%% Plot

if strcmp(plotter, 'plot')
    selectedCurve = 1;
    
    f = figure; hold on
    plot(hazardCurvesInterp(:,1), hazardCurvesInterp(:,selectedCurve+1), 'LineWidth', 1)
    xlim = f.Children.XLim; ylim = f.Children.YLim;
    plot(hazardCurvesInterp(:,1), MAFim)
    
    plot(expectedLossCurves(:,1), expectedLossCurves(:,selectedCurve+1), 'LineWidth', 1)
    plot(expectedLossCurves(1:lastStepIM,1), MAFlr(:,selectedCurve), 'LineWidth', 2)
    f.Children.XLim = xlim; f.Children.YLim = ylim;
    
    legend('MAFE(IM)', 'MAF(IM)', 'LR(IM)', 'MAF(IM)*LR(IM)')
    xlabel('Intensity measure');
    set(gca, 'FontSize', 18)
    
    annotation(f,'textbox',...
        [0.676785714285714 0.56904761904762 0.214285714285712 0.0690476190476207],...
        'String', sprintf('EAL = %2.2f%%', EAL*100),...
        'FontSize',18,'FontName','Helvetica Neue','FitBoxToText','off');
    
    if nargout > 1
        figure; hold on
        plot(lossExceedenceCurve{selectedCurve}(:,1), ...
            lossExceedenceCurve{selectedCurve}(:,2), 'LineWidth', 2)
        xlabel('LR'); ylabel('MAFE(LR)')
        set(gca, 'FontSize', 18)
    end
end

end
