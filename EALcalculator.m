function [ EAL, lossExceedenceCurve ] = EALcalculator(...
    expectedLossCurves, hazardCurves, plotter)
%EALcalculator calculates the expected annual loss provided a set of
%vulnerability functions and hazard curves
%
%
%   Note: if the hazard curve does not sstart from zero, this function
%   will extrapolate it for values smaller than IMmin
%
%  	vulnerabilities     array containing the IM in the first column,
%                       loss ratios | IM in the other columns
%   hazardCurves        array containing the IM in the first column,
%                       MAFE of IM in the other columns
%                       IT MUST HAVE THE SAME NUMBER OF COLUMNS THAN
%                       "vulnerabilities"

%% Example

% vulnerability = [0,0,0,0;0.0500000000000000,4.70302973241152e-12,4.70302973241152e-12,4.70302973241152e-12;0.100000000000000,9.67754899629492e-06,9.67754899629492e-06,9.67754899629492e-06;0.150000000000000,0.00112698573115912,0.00112698573115912,0.00112698573115912;0.200000000000000,0.00717313814937606,0.00717313814937606,0.00717313814937606;0.250000000000000,0.0154177923755553,0.0154177923755553,0.0154177923755553;0.300000000000000,0.0242533506354697,0.0242533506354697,0.0242533506354697;0.350000000000000,0.0371232589412291,0.0371232589412291,0.0371232589412291;0.400000000000000,0.0547940483359678,0.0547940483359678,0.0547940483359678;0.450000000000000,0.0761580875380843,0.0761580875380843,0.0761580875380843;0.500000000000000,0.102349671457028,0.102349671457028,0.102349671457028;0.550000000000000,0.137036561462965,0.137036561462965,0.137036561462965;0.600000000000000,0.183882305471137,0.183882305471137,0.183882305471137;0.650000000000000,0.244295470643605,0.244295470643605,0.244295470643605;0.700000000000000,0.316780653125123,0.316780653125123,0.316780653125123;0.750000000000000,0.397590349532314,0.397590349532314,0.397590349532314;0.800000000000000,0.481910969188673,0.481910969188673,0.481910969188673;0.850000000000000,0.564988564101765,0.564988564101765,0.564988564101765;0.900000000000000,0.642905214926925,0.642905214926925,0.642905214926925;0.950000000000000,0.712950049816945,0.712950049816945,0.712950049816945;1,0.773657216896249,0.773657216896249,0.773657216896249;1.05000000000000,0.824629776806451,0.824629776806451,0.824629776806451;1.10000000000000,0.866264388508343,0.866264388508343,0.866264388508343;1.15000000000000,0.899463071348441,0.899463071348441,0.899463071348441;1.20000000000000,0.925383878737981,0.925383878737981,0.925383878737981;1.25000000000000,0.945252798127726,0.945252798127726,0.945252798127726;1.30000000000000,0.960238848438126,0.960238848438126,0.960238848438126;1.35000000000000,0.971383120058850,0.971383120058850,0.971383120058850;1.40000000000000,0.979568250216904,0.979568250216904,0.979568250216904;1.45000000000000,0.985514938995969,0.985514938995969,0.985514938995969;1.50000000000000,0.989794387712279,0.989794387712279,0.989794387712279;1.55000000000000,0.992848479997810,0.992848479997810,0.992848479997810;1.60000000000000,0.995012280663237,0.995012280663237,0.995012280663237;1.65000000000000,0.996535632006323,0.996535632006323,0.996535632006323;1.70000000000000,0.997602208592474,0.997602208592474,0.997602208592474;1.75000000000000,0.998345423787204,0.998345423787204,0.998345423787204;1.80000000000000,0.998861191304741,0.998861191304741,0.998861191304741;1.85000000000000,0.999217860527368,0.999217860527368,0.999217860527368;1.90000000000000,0.999463771322546,0.999463771322546,0.999463771322546;1.95000000000000,0.999632890868098,0.999632890868098,0.999632890868098;2,0.999748954679863,0.999748954679863,0.999748954679863;2.05000000000000,0.999828469903070,0.999828469903070,0.999828469903070;2.10000000000000,0.999882870156286,0.999882870156286,0.999882870156286;2.15000000000000,0.999920047684166,0.999920047684166,0.999920047684166;2.20000000000000,0.999945434453265,0.999945434453265,0.999945434453265;2.25000000000000,0.999962760047783,0.999962760047783,0.999962760047783;2.30000000000000,0.999974580073420,0.999974580073420,0.999974580073420;2.35000000000000,0.999982642846876,0.999982642846876,0.999982642846876;2.40000000000000,0.999988142862100,0.999988142862100,0.999988142862100;2.45000000000000,0.999991895413472,0.999991895413472,0.999991895413472;2.50000000000000,0.999994456567618,0.999994456567618,0.999994456567618;2.55000000000000,0.999996205398704,0.999996205398704,0.999996205398704;2.60000000000000,0.999997400250990,0.999997400250990,0.999997400250990;2.65000000000000,0.999998217173454,0.999998217173454,0.999998217173454;2.70000000000000,0.999998776144347,0.999998776144347,0.999998776144347;2.75000000000000,0.999999158948468,0.999999158948468,0.999999158948468;2.80000000000000,0.999999421356204,0.999999421356204,0.999999421356204;2.85000000000000,0.999999601417114,0.999999601417114,0.999999601417114;2.90000000000000,0.999999725106403,0.999999725106403,0.999999725106403;2.95000000000000,0.999999810169043,0.999999810169043,0.999999810169043;3,0.999999868737184,0.999999868737184,0.999999868737184];
% hazardCurve   = [0.0500000000000000,0.0359165441238759,0.0359165441238759,0.0359165441238759;0.100000000000000,0.0214149470403168,0.0214149470403168,0.0214149470403168;0.150000000000000,0.0141288173865274,0.0141288173865274,0.0141288173865274;0.200000000000000,0.0100437113851045,0.0100437113851045,0.0100437113851045;0.250000000000000,0.00767863362714298,0.00767863362714298,0.00767863362714298;0.300000000000000,0.00608342464212812,0.00608342464212812,0.00608342464212812;0.350000000000000,0.00501480789002844,0.00501480789002844,0.00501480789002844;0.400000000000000,0.00417984570883490,0.00417984570883490,0.00417984570883490;0.450000000000000,0.00355345234307129,0.00355345234307129,0.00355345234307129;0.500000000000000,0.00306210689702328,0.00306210689702328,0.00306210689702328;0.550000000000000,0.00265756689564624,0.00265756689564624,0.00265756689564624;0.600000000000000,0.00235526466285869,0.00235526466285869,0.00235526466285869;0.650000000000000,0.00212683409883222,0.00212683409883222,0.00212683409883222;0.700000000000000,0.00191415031415710,0.00191415031415710,0.00191415031415710;0.750000000000000,0.00173491167801875,0.00173491167801875,0.00173491167801875;0.800000000000000,0.00157161733797149,0.00157161733797149,0.00157161733797149;0.850000000000000,0.00144363552062756,0.00144363552062756,0.00144363552062756;0.900000000000000,0.00133465010489144,0.00133465010489144,0.00133465010489144;0.950000000000000,0.00123549224420488,0.00123549224420488,0.00123549224420488;1,0.00114152496535817,0.00114152496535817,0.00114152496535817;1.05000000000000,0.00105045132688451,0.00105045132688451,0.00105045132688451;1.10000000000000,0.000970843977218302,0.000970843977218302,0.000970843977218302;1.15000000000000,0.000905477311111123,0.000905477311111123,0.000905477311111123;1.20000000000000,0.000840110645003945,0.000840110645003945,0.000840110645003945;1.25000000000000,0.000782620855512434,0.000782620855512434,0.000782620855512434;1.30000000000000,0.000737640819650741,0.000737640819650741,0.000737640819650741;1.35000000000000,0.000692660783789047,0.000692660783789047,0.000692660783789047;1.40000000000000,0.000647680747927353,0.000647680747927353,0.000647680747927353;1.45000000000000,0.000602700712065659,0.000602700712065659,0.000602700712065659;1.50000000000000,0.000573203422687330,0.000573203422687330,0.000573203422687330;1.55000000000000,0.000544695137779339,0.000544695137779339,0.000544695137779339;1.60000000000000,0.000516186852871348,0.000516186852871348,0.000516186852871348;1.65000000000000,0.000487678567963358,0.000487678567963358,0.000487678567963358;1.70000000000000,0.000459170283055367,0.000459170283055367,0.000459170283055367;1.75000000000000,0.000430661998147376,0.000430661998147376,0.000430661998147376;1.80000000000000,0.000402153713239386,0.000402153713239386,0.000402153713239386;1.85000000000000,0.000389826751624077,0.000389826751624077,0.000389826751624077;1.90000000000000,0.000378822138580562,0.000378822138580562,0.000378822138580562;1.95000000000000,0.000367817525537048,0.000367817525537048,0.000367817525537048;2,0.000356812912493534,0.000356812912493534,0.000356812912493534;2.05000000000000,0.000345808299450019,0.000345808299450019,0.000345808299450019;2.10000000000000,0.000334803686406505,0.000334803686406505,0.000334803686406505;2.15000000000000,0.000323799073362990,0.000323799073362990,0.000323799073362990;2.20000000000000,0.000312794460319476,0.000312794460319476,0.000312794460319476;2.25000000000000,0.000301789847275961,0.000301789847275961,0.000301789847275961;2.30000000000000,0.000290785234232447,0.000290785234232447,0.000290785234232447;2.35000000000000,0.000279780621188932,0.000279780621188932,0.000279780621188932;2.40000000000000,0.000268776008145418,0.000268776008145418,0.000268776008145418;2.45000000000000,0.000257771395101903,0.000257771395101903,0.000257771395101903;2.50000000000000,0.000246766782058389,0.000246766782058389,0.000246766782058389;2.55000000000000,0.000235762169014874,0.000235762169014874,0.000235762169014874;2.60000000000000,0.000224757555971360,0.000224757555971360,0.000224757555971360;2.65000000000000,0.000213752942927845,0.000213752942927845,0.000213752942927845;2.70000000000000,0.000202748329884331,0.000202748329884331,0.000202748329884331];
% 
% [ EAL ] = EALcalculator(vulnerability, hazardCurve, 'plot');

%% Initial stuff

% is vulnerability "long" enough?
if max(expectedLossCurves(:,1)) < max(hazardCurves(:,1))
    error('Extend the definition of the vulnerability curve(s)')
end

% interp hazard curve where the vulnerability is defined
temp = find(expectedLossCurves(:,1) >= max(hazardCurves(:,1)));
lastStepIM = temp(1)-1;
for h = size(hazardCurves,2) : -1 : 2
    hazardCurvesInterp(:,h) = interp1(...
        hazardCurves(:,1), hazardCurves(:,h), ...
        expectedLossCurves(1:lastStepIM,1), 'linear', 'extrap');
end
hazardCurvesInterp(:,1) = expectedLossCurves(1:lastStepIM,1);

%% Calculate MAFim (derivative of the hazard curves)

dy = -diff(hazardCurvesInterp(:,2:end)); % MAFE del IM più piccolo meno MAFE del IM più grande
dx = diff(hazardCurvesInterp(:,1)) * ones(1, size(hazardCurvesInterp,2)-1);
MAFim = dy ./ dx;

% assume that for the last IM point, for which I cannot calculate the
% derivative, the derivative is equal to the second-to-last one
MAFim(end+1,:) = MAFim(end,:);

%% Calculate EAL for each building (columns in vulnerabilities and hazardCurves)

MAFlr = expectedLossCurves(1:lastStepIM,2:end) .* MAFim;
EAL = trapz(expectedLossCurves(1:lastStepIM,1), MAFlr);

%% Loss exceedence curve

if nargout > 1
    for c = size(hazardCurves,2) : -1 : 2
        lossExceedenceCurve{c-1}(:,1) = interp1(...
            expectedLossCurves(:,1), expectedLossCurves(:,c), hazardCurvesInterp(:,1));
        lossExceedenceCurve{c-1}(:,2) = hazardCurvesInterp(:,c);
    end
end

% Sanity check: this also gives EAL
% trapz(lossExceedenceCurve{c}(:,1), lossExceedenceCurve{c}(:,2)) 

%% Plot

if strcmp(plotter, 'plot')
    selectedCurve = 1;
    
    f = figure; hold on
    plot(hazardCurvesInterp(:,1), hazardCurvesInterp(:,selectedCurve+1), 'LineWidth', 1)
    xlim = f.Children.XLim; ylim = f.Children.YLim;
    plot(hazardCurvesInterp(:,1), MAFim)
    
    plot(expectedLossCurves(:,1), expectedLossCurves(:,selectedCurve+1), 'LineWidth', 1)
    plot(expectedLossCurves(1:lastStepIM,1), MAFlr(:,selectedCurve), 'LineWidth', 2)
    f.Children.XLim = xlim; f.Children.YLim = ylim;
    
    legend('MAFE(IM)', 'MAF(IM)', 'LR(IM)', 'MAF(IM)*LR(IM)')
    xlabel('Intensity measure');
    set(gca, 'FontSize', 18)
    
    annotation(f,'textbox',...
        [0.676785714285714 0.56904761904762 0.214285714285712 0.0690476190476207],...
        'String', sprintf('EAL = %2.2f%%', EAL*100),...
        'FontSize',18,'FontName','Helvetica Neue','FitBoxToText','off');
    
    if nargout > 1
        figure; hold on
        plot(lossExceedenceCurve{selectedCurve}(:,1), ...
            lossExceedenceCurve{selectedCurve}(:,2), 'LineWidth', 2)
        xlabel('LR'); ylabel('MAFE(LR)')
        set(gca, 'FontSize', 18)
    end
end

end
